<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Media Player + AI English Learning Platform" />
  <meta name="keywords" content="English Learning, Music, Lyrics, AI, Quiz" />
  <meta name="author" content="Tr·∫ßn Qu·ªëc Trung" />
  <title>Media ‚Ä¢ AI English Learning</title>

  <style>
    /* =========================
       RESET + THEME
       ========================= */
    *{ margin:0; padding:0; box-sizing:border-box; }
    html{ scroll-behavior:smooth; }
    body{
      min-height:100vh;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(900px 500px at 15% 10%, rgba(255,59,59,.18), transparent 55%),
                  radial-gradient(900px 500px at 80% 20%, rgba(255,213,74,.14), transparent 60%),
                  radial-gradient(700px 500px at 40% 85%, rgba(74,144,255,.10), transparent 55%),
                  linear-gradient(180deg, #05070c 0%, #070A10 100%);
      color: rgba(255,255,255,.92);
      overflow-x:hidden;
    }
    :root{
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --muted2:rgba(255,255,255,.56);
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.12);
      --brand:#ff3b3b;
      --brand2:#ffd54a;
      --radius:18px;
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --ring:0 0 0 4px rgba(255,59,59,.12);
      --max:1200px;
    }

    .wrap{ max-width:var(--max); margin:0 auto; padding:16px; }
    header{
      position:sticky; top:0; z-index:50;
      background: rgba(7,10,16,.62);
      border-bottom:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
    }
    .nav{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 0;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .badge{
      width:38px; height:38px; border-radius:14px;
      display:grid; place-items:center;
      background:linear-gradient(135deg, rgba(255,59,59,.22), rgba(255,213,74,.18));
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 14px 40px rgba(0,0,0,.18);
      flex:0 0 auto;
      font-weight:900;
      color:transparent;
      background-clip:text;
      -webkit-background-clip:text;
    }
    .brand h1{
      font-size:14px; line-height:1.2; font-weight:900;
      letter-spacing:.2px;
    }
    .brand p{ font-size:12px; color:var(--muted2); font-weight:800; }

    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1.05fr .95fr;
      margin-top:14px;
    }
    @media (max-width: 960px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, var(--panel) 0%, rgba(255,255,255,.04) 100%);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .titleRow{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .titleRow h2{ font-size:16px; font-weight:900; letter-spacing:.2px; }
    .muted{ color:var(--muted); font-size:13px; }

    .playerBox{
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.03);
      overflow:hidden;
    }
    .playerBox iframe{
      width:100%; height:380px; border:0; display:block; background:#000;
    }
    @media (max-width:560px){
      .playerBox iframe{ height:240px; }
    }

    .controls{
      display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;
      align-items:center;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--txt);
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      transition:.18s ease;
      user-select:none;
    }
    .btn:hover{ transform:translateY(-1px); background:rgba(255,255,255,.07); }
    .btn:focus{ outline:none; box-shadow:var(--ring); }
    .btn.active{
      border-color: rgba(255,59,59,.35);
      background:linear-gradient(135deg, rgba(255,59,59,.20), rgba(255,213,74,.12));
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-weight:900; font-size:12px;
      white-space:nowrap;
    }

    .now{
      display:grid; gap:4px;
      margin-top:10px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }
    .now b{ font-size:14px; font-weight:900; }
    .now span{ font-size:12px; color:var(--muted); font-weight:800; }

    .playlistTools{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;
    }
    .input, .select, .textarea{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--txt);
      font-weight:800;
      font-size:13px;
      outline:none;
      width:100%;
    }
    .playlistScroll{
      max-height:520px;
      overflow:auto;
      padding-right:6px;
    }
    .playlistScroll::-webkit-scrollbar{ width:10px; }
    .playlistScroll::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.14);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
    }
    .track{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.04);
      padding:12px;
      cursor:pointer;
      transition:.18s ease;
      display:grid; gap:6px;
      margin-bottom:10px;
    }
    .track:hover{ transform:translateY(-1px); background:rgba(255,255,255,.06); }
    .track.active{
      border-color: rgba(255,59,59,.35);
      background:linear-gradient(135deg, rgba(255,59,59,.18), rgba(255,213,74,.10));
    }
    .trackTop{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .trackTitle{ font-weight:900; font-size:13px; }
    .trackMeta{ color:var(--muted2); font-weight:900; font-size:11px; letter-spacing:.6px; text-transform:uppercase; }
    .trackDesc{ color:var(--muted); font-size:12.5px; line-height:1.55; margin:0; }

    .twoCol{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width: 900px){ .twoCol{ grid-template-columns:1fr; } }

    .hint{
      display:flex; gap:8px; align-items:center;
      font-size:12px; color:var(--muted);
      margin-top:8px;
      padding:8px 10px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
    }
    .dot{ width:8px; height:8px; border-radius:999px; background:rgba(0,200,120,.9); }

    .toast{
      position:fixed;
      right:16px; bottom:16px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.65);
      color:rgba(255,255,255,.92);
      font-weight:900;
      display:none;
      z-index:120;
      backdrop-filter: blur(10px);
      max-width: 360px;
    }
    .toast.show{ display:block; }

    .smallRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .small{ font-size:12px; color:var(--muted2); font-weight:900; }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="nav">
        <div class="brand">
          <div class="badge"><span>VS</span></div>
          <div>
            <h1>üéß Media ‚Ä¢ AI English Learning</h1>
            <p>Learn English through Music, Lyrics & AI</p>
          </div>
        </div>
        <div class="pill" title="Ph√≠m t·∫Øt">
          ‚å®Ô∏è <span class="small">‚Üê/‚Üí Next/Prev ‚Ä¢ S Shuffle ‚Ä¢ R Repeat ‚Ä¢ Ctrl+Enter Translate</span>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <div class="titleRow">
          <h2>üéµ Media Player</h2>
          <span class="muted">YouTube Embed</span>
        </div>

        <div class="playerBox">
          <iframe id="ytPlayer" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>

        <div class="controls">
          <button class="btn" id="btnPrev">‚èÆ Prev</button>
          <button class="btn" id="btnNext">Next ‚è≠</button>
          <button class="btn" id="btnShuffle">üîÄ Shuffle</button>
          <button class="btn" id="btnRepeat" data-mode="all">üîÅ Repeat: ALL</button>
          <button class="btn" id="btnCopyLink">üîó Copy Link</button>
          <button class="btn" id="btnSaveTime">‚è± Save Time</button>
          <button class="btn" id="btnResetTime">‚ü≤ Reset Time</button>
        </div>

        <div class="now">
          <b id="nowTitle">‚Äî</b>
          <span id="nowMeta">‚Äî</span>
          <span id="nowType">YouTube</span>
        </div>

        <div style="height:12px"></div>

        <div class="titleRow">
          <h2>üìù Lyrics (EN / VI)</h2>
          <span class="muted">L∆∞u theo t·ª´ng b√†i</span>
        </div>

        <div class="twoCol">
          <div>
            <div class="smallRow">
              <b class="small">Lyrics EN</b>
              <span class="muted small">(#lyricEN)</span>
            </div>
            <textarea id="lyricEN" class="textarea" rows="7" placeholder="Paste lyrics EN here..."></textarea>
          </div>
          <div>
            <div class="smallRow">
              <b class="small">Lyrics VI</b>
              <span class="muted small">(#lyricVI)</span>
            </div>
            <textarea id="lyricVI" class="textarea" rows="7" placeholder="Paste lyrics VI here..."></textarea>
          </div>
        </div>

        <div class="controls">
          <button class="btn" id="btnSaveLyric">üíæ Save Lyrics</button>
          <button class="btn" id="btnLoadLyric">üì• Load Saved</button>
          <button class="btn" id="btnClearLyric">üßπ Clear For This Song</button>
        </div>

        <div style="height:10px"></div>

        <div class="titleRow">
          <h2>üåç Translate (EN ‚áÑ VI)</h2>
          <span class="muted">Offline / API</span>
        </div>

        <div class="twoCol">
          <div>
            <b class="small">Input</b>
            <textarea id="trSrc" class="textarea" rows="6" placeholder="Paste English or Vietnamese here..."></textarea>

            <div class="controls">
              <select id="trDir" class="select" style="max-width:220px">
                <option value="en2vi">EN ‚Üí VI</option>
                <option value="vi2en">VI ‚Üí EN</option>
              </select>
              <button class="btn" id="btnTranslate">Translate</button>
              <button class="btn" id="btnSwapTr">Swap</button>
              <button class="btn" id="btnApplyToLyrics">Apply ‚Üí Lyrics</button>
              <button class="btn" id="btnToggleMode" title="Alt+T">Mode: OFFLINE</button>
            </div>

            <div class="hint">
              <span class="dot"></span>
              <span>Tip: set API_URL trong JS n·∫øu mu·ªën d·ªãch ‚Äúx·ªãn‚Äù online.</span>
            </div>
          </div>

          <div>
            <div class="smallRow">
              <b class="small">Output</b>
              <span class="muted small" id="lyricProgress"></span>
            </div>
            <textarea id="trOut" class="textarea" rows="6" readonly placeholder="Translation result..."></textarea>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="titleRow">
          <h2>üìö Lyrics Library (Saved)</h2>
          <span class="muted">Backup JSON</span>
        </div>

        <div class="playlistTools">
          <input id="lyricsSearch" class="input" placeholder="Search saved lyrics..." />
          <button class="btn" id="btnExportLyrics">Export JSON</button>
          <button class="btn" id="btnImportLyrics">Import JSON</button>
          <button class="btn" id="btnClearAllLyrics">Clear ALL</button>
          <input type="file" id="fileImportLyrics" accept="application/json" hidden />
        </div>

        <div id="lyricsLibrary"></div>
      </section>

      <!-- RIGHT -->
      <aside class="card">
        <div class="titleRow">
          <h2>üé∂ Playlist</h2>
          <span class="muted" id="plCount">0 tracks</span>
        </div>

        <div class="playlistTools">
          <input id="trackSearch" class="input" placeholder="Search tracks (title/artist/tag)..." />
        </div>

        <div class="playlistScroll">
          <div id="playlist"></div>
        </div>
      </aside>
    </div>
  </main>

  <div id="toast" class="toast">‚Äî</div>

  <script>
    /* =========================================================
       Media ‚Ä¢ AI English Learning (Single-file)
       Clean build: NO duplicate vars ‚Ä¢ IDs matched ‚Ä¢ runs ready
       Author: Tr·∫ßn Qu·ªëc Trung
       ========================================================= */

    // ---------- Helpers ----------
    const $  = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
    function toast(msg){
      const el = $("#toast");
      if(!el) return alert(msg);
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.classList.remove("show"), 1800);
    }
    function safeJSONParse(str, fallback){
      try{ return JSON.parse(str); }catch(e){ return fallback; }
    }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function norm(str){
      return (str||"")
        .toString()
        .trim()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g,"");
    }
    function escapeHTML(s){
      return (s ?? "")
        .toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ---------- DOM ----------
    const ytPlayer     = $("#ytPlayer");
    const playlistEl   = $("#playlist");
    const searchEl     = $("#trackSearch");
    const nowTitleEl   = $("#nowTitle");
    const nowMetaEl    = $("#nowMeta");
    const nowTypeEl    = $("#nowType");
    const plCountEl    = $("#plCount");

    const btnPrev      = $("#btnPrev");
    const btnNext      = $("#btnNext");
    const btnShuffle   = $("#btnShuffle");
    const btnRepeat    = $("#btnRepeat");
    const btnCopyLink  = $("#btnCopyLink");
    const btnSaveTime  = $("#btnSaveTime");
    const btnResetTime = $("#btnResetTime");

    const lyricEnEl    = $("#lyricEN");
    const lyricViEl    = $("#lyricVI");
    const btnSaveLyric = $("#btnSaveLyric");
    const btnLoadLyric = $("#btnLoadLyric");
    const btnClearLyric= $("#btnClearLyric");

    const trSrcEl      = $("#trSrc");
    const trOutEl      = $("#trOut");
    const trDirEl      = $("#trDir");
    const btnTranslate = $("#btnTranslate");
    const btnSwapTr    = $("#btnSwapTr");
    const btnApplyToLyrics = $("#btnApplyToLyrics");
    const btnToggleMode = $("#btnToggleMode");
    const progEl       = $("#lyricProgress");

    const btnExportLyrics  = $("#btnExportLyrics");
    const btnImportLyrics  = $("#btnImportLyrics");
    const fileImportLyrics = $("#fileImportLyrics");
    const btnClearAllLyrics= $("#btnClearAllLyrics");
    const lyricsLibEl      = $("#lyricsLibrary");
    const lyricsSearchEl   = $("#lyricsSearch");

    // ---------- Data (playlist) ----------
    // Anh c√≥ th·ªÉ th√™m bao nhi√™u b√†i t√πy √Ω. Quan tr·ªçng: videoId ph·∫£i ƒë√∫ng.
    const MEDIA = [
      { type:"MUSIC", title:"Despacito ‚Äî Luis Fonsi ft. Daddy Yankee", meta:"GLOBAL", desc:"Official video", videoId:"kJQP7kiw5Fk" },
      { type:"MUSIC", title:"See You Again ‚Äî Wiz Khalifa ft. Charlie Puth", meta:"US/UK", desc:"Official video", videoId:"RgKAFK5djSk" },
      { type:"MUSIC", title:"Shape of You ‚Äî Ed Sheeran", meta:"US/UK", desc:"Official video", videoId:"JGwWNGJdvx8" },
      { type:"MUSIC", title:"Uptown Funk ‚Äî Mark Ronson ft. Bruno Mars", meta:"US/UK", desc:"Official video", videoId:"OPf0YbXqDm0" },
      { type:"MUSIC", title:"Gangnam Style ‚Äî PSY", meta:"K-POP", desc:"Official video", videoId:"9bZkp7q19f0" },
      { type:"MUSIC", title:"Faded ‚Äî Alan Walker", meta:"EDM", desc:"Official video", videoId:"60ItHLz5WEA" },
      { type:"MUSIC", title:"Hello ‚Äî Adele", meta:"US/UK", desc:"Official video", videoId:"YQHsXMglC9A" },
      { type:"MUSIC", title:"Believer ‚Äî Imagine Dragons", meta:"US/UK", desc:"Official video", videoId:"7wtfhZwyrcc" },
      { type:"MUSIC", title:"bad guy ‚Äî Billie Eilish", meta:"US/UK", desc:"Official video", videoId:"DyDfgMOUjCI" },
      { type:"MUSIC", title:"Dynamite ‚Äî BTS", meta:"K-POP", desc:"Official MV", videoId:"gdZLi9oWNZg" },
      { type:"MUSIC", title:"How You Like That ‚Äî BLACKPINK", meta:"K-POP", desc:"Official MV", videoId:"ioNng23DkIM" },
      { type:"MUSIC", title:"Mi Gente ‚Äî J Balvin, Willy William", meta:"LATIN", desc:"Official video", videoId:"wnJ6LuUFpMo" },
      { type:"MUSIC", title:"Take On Me ‚Äî a-ha", meta:"CLASSIC", desc:"Official video", videoId:"djV11Xbc914" },
      { type:"MUSIC", title:"Smells Like Teen Spirit ‚Äî Nirvana", meta:"CLASSIC", desc:"Official video", videoId:"hTWKbfoikeg" },
      { type:"MUSIC", title:"Billie Jean ‚Äî Michael Jackson", meta:"CLASSIC", desc:"Official video", videoId:"Zi_XLOBDo_Y" }
    ];

    const TRACKS = MEDIA.map(x => ({
      id: x.videoId,
      title: x.title,
      artist: x.meta,
      tag: x.type,
      note: x.desc,
      start: x.start || 0
    }));

    // ---------- Storage keys ----------
    const LS = {
      mediaState: "MVAPP_MEDIA_STATE_V1",
      lyrics:     "MVAPP_LYRICS_V1",
      translate:  "MVAPP_TRANSLATE_STATE_V1"
    };

    // ---------- State ----------
    const state = {
      idx: 0,
      shuffle: false,
      repeat: "all", // off | one | all
      filter: "",
      lastStartSec: 0
    };

    (function restoreMediaState(){
      const saved = safeJSONParse(localStorage.getItem(LS.mediaState), null);
      if(!saved) return;
      if(Number.isInteger(saved.idx)) state.idx = clamp(saved.idx, 0, TRACKS.length-1);
      if(typeof saved.shuffle === "boolean") state.shuffle = saved.shuffle;
      if(["off","one","all"].includes(saved.repeat)) state.repeat = saved.repeat;
      if(typeof saved.lastStartSec === "number") state.lastStartSec = Math.max(0, saved.lastStartSec);
    })();

    function saveMediaState(){
      localStorage.setItem(LS.mediaState, JSON.stringify({
        idx: state.idx,
        shuffle: state.shuffle,
        repeat: state.repeat,
        lastStartSec: state.lastStartSec
      }));
    }

    // ---------- Playlist UI ----------
    function filteredTracks(){
      const f = norm(state.filter);
      if(!f) return TRACKS.map((t,i)=> ({...t, _i:i}));
      return TRACKS
        .map((t,i)=> ({...t, _i:i}))
        .filter(t=>{
          const hay = norm(`${t.title} ${t.artist||""} ${t.tag||""} ${t.note||""}`);
          return hay.includes(f);
        });
    }

    function renderPlaylist(){
      if(!playlistEl) return;
      const list = filteredTracks();
      if(plCountEl) plCountEl.textContent = `${list.length} tracks`;

      if(list.length === 0){
        playlistEl.innerHTML = `<div class="track"><div class="trackTitle">No results</div><p class="trackDesc">Kh√¥ng t√¨m th·∫•y b√†i ph√π h·ª£p.</p></div>`;
        return;
      }

      playlistEl.innerHTML = list.map(t=>{
        const isActive = t._i === state.idx;
        const meta = [t.artist, t.tag].filter(Boolean).join(" ‚Ä¢ ");
        return `
          <div class="track ${isActive ? "active":""}" data-idx="${t._i}">
            <div class="trackTop">
              <div class="trackTitle">${escapeHTML(t.title)}</div>
              <div class="trackMeta">${escapeHTML(meta || "TRACK")}</div>
            </div>
            ${t.note ? `<p class="trackDesc">${escapeHTML(t.note)}</p>` : ``}
          </div>
        `;
      }).join("");
    }

    // ---------- YouTube ----------
    function buildYouTubeSrc(videoId, startSec=0){
      const s = Math.max(0, Math.floor(startSec||0));
      return `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=0&controls=1&rel=0&modestbranding=1&start=${s}`;
    }

    function readLyricsStore(){
      return safeJSONParse(localStorage.getItem(LS.lyrics), {});
    }
    function writeLyricsStore(obj){
      localStorage.setItem(LS.lyrics, JSON.stringify(obj));
    }

    function loadLyricsForCurrent(showToast=false){
      const t = TRACKS[state.idx];
      if(!t) return;
      const store = readLyricsStore();
      const data = store[t.id];
      if(lyricEnEl) lyricEnEl.value = data?.en || "";
      if(lyricViEl) lyricViEl.value = data?.vi || "";
      if(showToast) toast(data ? "üì• Loaded lyrics" : "‚ÑπÔ∏è No saved lyrics");
    }

    function saveLyricsForCurrent(){
      const t = TRACKS[state.idx];
      if(!t) return;
      const store = readLyricsStore();
      store[t.id] = {
        title: t.title || "",
        artist: t.artist || "",
        en: (lyricEnEl?.value || "").trim(),
        vi: (lyricViEl?.value || "").trim(),
        updatedAt: Date.now()
      };
      writeLyricsStore(store);
      renderLyricsLibrary();
      toast("‚úÖ Saved lyrics!");
    }

    function clearLyricsForCurrent(){
      const t = TRACKS[state.idx];
      if(!t) return;
      const store = readLyricsStore();
      delete store[t.id];
      writeLyricsStore(store);
      if(lyricEnEl) lyricEnEl.value = "";
      if(lyricViEl) lyricViEl.value = "";
      renderLyricsLibrary();
      toast("üßπ Cleared lyrics for this song");
    }

    function loadTrack(index, opts={}){
      if(!TRACKS.length) return;
      state.idx = clamp(index, 0, TRACKS.length-1);
      const t = TRACKS[state.idx];

      let startSec = 0;
      if(typeof opts.startSec === "number") startSec = Math.max(0, opts.startSec);
      else{
        startSec = Math.max(0, t.start || 0);
        if(opts.useSavedTime && state.lastStartSec > 0) startSec = state.lastStartSec;
      }

      if(ytPlayer) ytPlayer.src = buildYouTubeSrc(t.id, startSec);

      if(nowTitleEl) nowTitleEl.textContent = t.title || "Now playing";
      if(nowMetaEl)  nowMetaEl.textContent  = [t.artist, t.tag].filter(Boolean).join(" ‚Ä¢ ") || "";
      if(nowTypeEl)  nowTypeEl.textContent  = "YouTube";

      renderPlaylist();
      loadLyricsForCurrent(false);
      saveMediaState();
    }

    function nextIndex(){
      if(state.shuffle){
        if(TRACKS.length <= 1) return state.idx;
        let j = state.idx;
        while(j === state.idx) j = Math.floor(Math.random() * TRACKS.length);
        return j;
      }
      return (state.idx + 1) % TRACKS.length;
    }
    function prevIndex(){
      if(state.shuffle){
        if(TRACKS.length <= 1) return state.idx;
        let j = state.idx;
        while(j === state.idx) j = Math.floor(Math.random() * TRACKS.length);
        return j;
      }
      return (state.idx - 1 + TRACKS.length) % TRACKS.length;
    }

    async function copyCurrentLink(){
      const t = TRACKS[state.idx];
      if(!t) return;
      const url = `https://youtu.be/${t.id}`;
      try{
        await navigator.clipboard.writeText(url);
        toast("üîó Copied link");
      }catch(e){
        toast("‚ùå Copy failed");
      }
    }

    function saveTimeManual(){
      const raw = prompt("Nh·∫≠p s·ªë gi√¢y (start time) ƒë·ªÉ l∆∞u:", String(state.lastStartSec || 0));
      if(raw === null) return;
      let sec = parseFloat(raw);
      if(!Number.isFinite(sec) || sec < 0) sec = 0;
      state.lastStartSec = Math.floor(sec);
      saveMediaState();
      toast("‚è±Ô∏è Saved start time");
    }
    function resetTimeManual(){
      state.lastStartSec = 0;
      saveMediaState();
      toast("‚ü≤ Reset saved time");
    }

    // ---------- Translate engine ----------
    const TR = {
      MODE: "offline", // offline | api
      API_URL: "",     // n·∫øu d√πng LibreTranslate/self-host, ƒëi·ªÅn v√†o ƒë√¢y
      TIMEOUT: 12000
    };

    function restoreTranslateState(){
      const saved = safeJSONParse(localStorage.getItem(LS.translate), null);
      if(!saved) return;
      if(typeof saved.src === "string" && trSrcEl) trSrcEl.value = saved.src;
      if(typeof saved.out === "string" && trOutEl) trOutEl.value = saved.out;
      if((saved.dir === "en2vi" || saved.dir === "vi2en") && trDirEl) trDirEl.value = saved.dir;
      if(saved.mode === "offline" || saved.mode === "api") TR.MODE = saved.mode;
      if(typeof saved.apiUrl === "string") TR.API_URL = saved.apiUrl;
    }
    function saveTranslateState(){
      localStorage.setItem(LS.translate, JSON.stringify({
        src: trSrcEl?.value || "",
        out: trOutEl?.value || "",
        dir: trDirEl?.value || "en2vi",
        mode: TR.MODE,
        apiUrl: TR.API_URL
      }));
    }

    // Mini offline dictionary (demo)
    const MINI_EN2VI = {
      "hello":"xin ch√†o","hi":"ch√†o","good":"t·ªët","bad":"t·ªá","morning":"bu·ªïi s√°ng","night":"bu·ªïi t·ªëi",
      "thank you":"c·∫£m ∆°n","thanks":"c·∫£m ∆°n","sorry":"xin l·ªói","love":"y√™u","miss":"nh·ªõ",
      "you":"b·∫°n","i":"t√¥i","we":"ch√∫ng t√¥i","they":"h·ªç","he":"anh ·∫•y","she":"c√¥ ·∫•y",
      "music":"√¢m nh·∫°c","song":"b√†i h√°t","lyrics":"l·ªùi b√†i h√°t","today":"h√¥m nay","tomorrow":"ng√†y mai","yesterday":"h√¥m qua",
      "happy":"vui","sad":"bu·ªìn","beautiful":"ƒë·∫πp","family":"gia ƒë√¨nh","friend":"b·∫°n","work":"c√¥ng vi·ªác","study":"h·ªçc","school":"tr∆∞·ªùng","home":"nh√†"
    };
    const MINI_VI2EN = Object.fromEntries(Object.entries(MINI_EN2VI).map(([en,vi])=>[vi,en]));

    function offlineTranslate(text, dir){
      const raw = (text || "").trim();
      if(!raw) return "";
      const dict = (dir === "en2vi") ? MINI_EN2VI : MINI_VI2EN;

      let out = raw;
      const keys = Object.keys(dict).sort((a,b)=> b.length - a.length);
      keys.forEach(k=>{
        const safe = k.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        const rx = new RegExp(`\\b${safe}\\b`, "gi");
        out = out.replace(rx, (m)=>{
          const rep = dict[k];
          if(!rep) return m;
          const isCap = m[0] === m[0].toUpperCase();
          return isCap ? rep.charAt(0).toUpperCase() + rep.slice(1) : rep;
        });
      });
      return out;
    }

    function fetchWithTimeout(url, opts={}, timeout=12000){
      return new Promise((resolve, reject)=>{
        const ctrl = new AbortController();
        const id = setTimeout(()=> ctrl.abort(), timeout);
        fetch(url, { ...opts, signal: ctrl.signal })
          .then(res => { clearTimeout(id); resolve(res); })
          .catch(err => { clearTimeout(id); reject(err); });
      });
    }

    async function apiTranslate(text, dir){
      if(!TR.API_URL) throw new Error("Missing API URL");
      const source = dir === "en2vi" ? "en" : "vi";
      const target = dir === "en2vi" ? "vi" : "en";
      const body = { q:text, source, target, format:"text" };

      const res = await fetchWithTimeout(TR.API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      }, TR.TIMEOUT);

      if(!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error(`API error ${res.status}: ${t.slice(0,200)}`);
      }
      const data = await res.json();
      const translated = data?.translatedText || data?.translation || data?.result;
      if(typeof translated !== "string") throw new Error("Bad API response");
      return translated;
    }

    async function doTranslate(){
      const text = (trSrcEl?.value || "").trim();
      const dir  = trDirEl?.value || "en2vi";
      if(!text){ toast("‚ö†Ô∏è Please enter text to translate"); return; }

      try{
        toast("‚è≥ Translating...");
        let result = "";
        if(TR.MODE === "api") result = await apiTranslate(text, dir);
        else result = offlineTranslate(text, dir);

        if(trOutEl) trOutEl.value = result;
        saveTranslateState();
        toast("‚úÖ Done");
      }catch(e){
        console.error(e);
        toast("‚ùå Translate failed (check MODE/API_URL)");
        if(trOutEl) trOutEl.value = "";
      }
    }

    function swapTranslate(){
      const a = trSrcEl?.value || "";
      const b = trOutEl?.value || "";
      if(trSrcEl) trSrcEl.value = b;
      if(trOutEl) trOutEl.value = a;

      const d = trDirEl?.value || "en2vi";
      if(trDirEl) trDirEl.value = (d === "en2vi") ? "vi2en" : "en2vi";
      saveTranslateState();
      toast("üîÅ Swapped");
    }

    function applyTranslateToLyrics(){
      const dir = trDirEl?.value || "en2vi";
      const src = (trSrcEl?.value || "").trim();
      const out = (trOutEl?.value || "").trim();
      if(!src && !out){ toast("‚ö†Ô∏è Nothing to apply"); return; }

      if(dir === "en2vi"){
        if(lyricEnEl) lyricEnEl.value = src;
        if(lyricViEl) lyricViEl.value = out;
      }else{
        if(lyricViEl) lyricViEl.value = src;
        if(lyricEnEl) lyricEnEl.value = out;
      }
      toast("‚úÖ Applied ‚Üí Lyrics");
    }

    function toggleTranslateMode(){
      TR.MODE = (TR.MODE === "offline") ? "api" : "offline";
      if(btnToggleMode) btnToggleMode.textContent = `Mode: ${TR.MODE.toUpperCase()}`;
      saveTranslateState();
      toast(`üåê Translate mode: ${TR.MODE.toUpperCase()}`);
      if(TR.MODE === "api" && !TR.API_URL) toast("‚ÑπÔ∏è API mode ON but API_URL is empty");
    }

    // ---------- Lyrics Library ----------
    function renderLyricsLibrary(){
      if(!lyricsLibEl) return;
      const q = norm(lyricsSearchEl?.value || "");
      const store = readLyricsStore();

      const items = Object.entries(store)
        .map(([id, v]) => ({ id, ...v }))
        .sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0))
        .filter(it=>{
          if(!q) return true;
          const hay = norm(`${it.title||""} ${it.artist||""} ${it.en||""} ${it.vi||""}`);
          return hay.includes(q);
        });

      if(items.length === 0){
        lyricsLibEl.innerHTML = `<div class="track"><div class="trackTitle">No saved lyrics</div><p class="trackDesc">Ch∆∞a c√≥ lyrics n√†o ƒë∆∞·ª£c l∆∞u.</p></div>`;
        return;
      }

      lyricsLibEl.innerHTML = items.map(it=>{
        const time = it.updatedAt ? new Date(it.updatedAt).toLocaleString() : "";
        const enShort = (it.en||"").slice(0,120);
        const viShort = (it.vi||"").slice(0,120);
        return `
          <div class="track" data-lyid="${escapeHTML(it.id)}">
            <div class="trackTop">
              <div class="trackTitle">${escapeHTML(it.title || it.id)}</div>
              <div class="trackMeta">${escapeHTML((it.artist||"") + (time ? " ‚Ä¢ " + time : ""))}</div>
            </div>
            <p class="trackDesc"><b>EN:</b> ${escapeHTML(enShort)}${(it.en||"").length>120?"‚Ä¶":""}</p>
            <p class="trackDesc"><b>VI:</b> ${escapeHTML(viShort)}${(it.vi||"").length>120?"‚Ä¶":""}</p>
          </div>
        `;
      }).join("");
    }

    function exportLyricsJSON(){
      const store = readLyricsStore();
      const payload = {
        app: "MediaAIEnglishLearning",
        type: "LyricsBackup",
        version: 1,
        exportedAt: new Date().toISOString(),
        total: Object.keys(store).length,
        data: store
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const url  = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `lyrics-backup-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("üì¶ Exported lyrics JSON");
    }

    function importLyricsJSONFile(file){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onload = ()=>{
          try{
            const obj = JSON.parse(fr.result);
            const data = obj?.data && typeof obj.data === "object" ? obj.data : null;
            if(!data) throw new Error("Missing data field");

            const cur = readLyricsStore();
            const merged = { ...cur, ...data };
            writeLyricsStore(merged);
            loadLyricsForCurrent(false);
            renderLyricsLibrary();
            toast(`‚úÖ Imported (${Object.keys(data).length})`);
            resolve(true);
          }catch(e){
            console.error(e);
            toast("‚ùå Import failed (JSON invalid)");
            reject(e);
          }
        };
        fr.onerror = ()=> reject(fr.error);
        fr.readAsText(file);
      });
    }

    function clearAllLyrics(){
      if(!confirm("X√≥a T·∫§T C·∫¢ lyrics ƒë√£ l∆∞u? (Kh√¥ng kh√¥i ph·ª•c ƒë∆∞·ª£c)")) return;
      writeLyricsStore({});
      loadLyricsForCurrent(false);
      renderLyricsLibrary();
      toast("üßπ Cleared ALL lyrics");
    }

    // ---------- Events ----------
    let BOUND = false;
    function bindEventsOnce(){
      if(BOUND) return;
      BOUND = true;

      // Playlist click (delegation)
      playlistEl?.addEventListener("click", (e)=>{
        const card = e.target.closest(".track[data-idx]");
        if(!card) return;
        const idx = parseInt(card.dataset.idx, 10);
        if(!Number.isInteger(idx)) return;
        state.lastStartSec = 0;
        loadTrack(idx, { startSec: TRACKS[idx]?.start || 0 });
      });

      // Search
      searchEl?.addEventListener("input", ()=>{
        state.filter = searchEl.value || "";
        renderPlaylist();
      });

      // Player controls
      btnNext?.addEventListener("click", ()=>{
        if(state.repeat === "one"){
          state.lastStartSec = 0;
          loadTrack(state.idx, { startSec: TRACKS[state.idx]?.start || 0 });
          return;
        }
        state.lastStartSec = 0;
        loadTrack(nextIndex(), { startSec: 0 });
      });

      btnPrev?.addEventListener("click", ()=>{
        state.lastStartSec = 0;
        loadTrack(prevIndex(), { startSec: 0 });
      });

      btnShuffle?.addEventListener("click", ()=>{
        state.shuffle = !state.shuffle;
        btnShuffle.classList.toggle("active", state.shuffle);
        saveMediaState();
        toast(state.shuffle ? "üîÄ Shuffle ON" : "‚û°Ô∏è Shuffle OFF");
      });

      btnRepeat?.addEventListener("click", ()=>{
        state.repeat = (state.repeat === "all") ? "one" : (state.repeat === "one" ? "off" : "all");
        btnRepeat.dataset.mode = state.repeat;
        btnRepeat.textContent = `üîÅ Repeat: ${state.repeat.toUpperCase()}`;
        saveMediaState();
        toast(`üîÅ Repeat: ${state.repeat.toUpperCase()}`);
      });

      btnCopyLink?.addEventListener("click", copyCurrentLink);
      btnSaveTime?.addEventListener("click", saveTimeManual);
      btnResetTime?.addEventListener("click", resetTimeManual);

      // Lyrics buttons
      btnSaveLyric?.addEventListener("click", saveLyricsForCurrent);
      btnLoadLyric?.addEventListener("click", ()=> loadLyricsForCurrent(true));
      btnClearLyric?.addEventListener("click", clearLyricsForCurrent);

      // Translate
      btnTranslate?.addEventListener("click", doTranslate);
      btnSwapTr?.addEventListener("click", swapTranslate);
      btnApplyToLyrics?.addEventListener("click", applyTranslateToLyrics);
      btnToggleMode?.addEventListener("click", toggleTranslateMode);

      trSrcEl?.addEventListener("keydown", (e)=>{
        if((e.ctrlKey || e.metaKey) && e.key === "Enter") doTranslate();
      });

      // Lyrics Library
      btnExportLyrics?.addEventListener("click", exportLyricsJSON);
      btnImportLyrics?.addEventListener("click", ()=>{
        if(!fileImportLyrics) return toast("Missing #fileImportLyrics");
        fileImportLyrics.click();
      });
      fileImportLyrics?.addEventListener("change", async ()=>{
        const file = fileImportLyrics.files?.[0];
        if(!file) return;
        await importLyricsJSONFile(file);
        fileImportLyrics.value = "";
      });
      btnClearAllLyrics?.addEventListener("click", clearAllLyrics);
      lyricsSearchEl?.addEventListener("input", renderLyricsLibrary);

      lyricsLibEl?.addEventListener("click", (e)=>{
        const card = e.target.closest(".track[data-lyid]");
        if(!card) return;
        const id = card.getAttribute("data-lyid");
        const store = readLyricsStore();
        const data = store[id];
        if(!data) return toast("Not found");
        if(lyricEnEl) lyricEnEl.value = data.en || "";
        if(lyricViEl) lyricViEl.value = data.vi || "";
        toast("üì• Loaded from library ‚Üí Lyrics box");
      });

      // Keyboard shortcuts
      document.addEventListener("keydown", (e)=>{
        if(e.target && ["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName)) return;
        if(e.key === "ArrowRight") btnNext?.click();
        if(e.key === "ArrowLeft")  btnPrev?.click();
        if(e.key.toLowerCase() === "s") btnShuffle?.click();
        if(e.key.toLowerCase() === "r") btnRepeat?.click();
        if(e.altKey && e.key.toLowerCase() === "t") toggleTranslateMode();
      });
    }

    // ---------- Init ----------
    function init(){
      if(!TRACKS.length){
        toast("‚ùå TRACKS empty");
        return;
      }
      restoreTranslateState();
      if(btnToggleMode) btnToggleMode.textContent = `Mode: ${TR.MODE.toUpperCase()}`;

      renderPlaylist();
      renderLyricsLibrary();
      btnShuffle?.classList.toggle("active", state.shuffle);
      btnRepeat.textContent = `üîÅ Repeat: ${state.repeat.toUpperCase()}`;
      btnRepeat.dataset.mode = state.repeat;

      bindEventsOnce();
      loadTrack(state.idx, { useSavedTime:true });
      toast("‚úÖ Ready");
    }

    if(document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", init, { once:true });
    }else{
      init();
    }
  </script>
</body>
</html>
